<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>CellarCount ‚Äì Vinlager</title>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f4f4f4;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
}
th { background: #eee; }
.right { text-align: right; }

button {
  padding: 6px 12px;
  margin: 4px 0;
}

.label {
  border: 1px solid #000;
  padding: 10px;
  margin: 10px;
  width: 260px;
  display: inline-block;
  background: white;
  font-size: 13px;
}

.total {
  font-size: 18px;
  font-weight: bold;
  margin: 10px 0;
}
</style>
</head>

<body>

<h1>üç∑ CellarCount</h1>
<p>Vinlager ‚Äì Hotel / Restaurant / Caf√©</p>

<hr>

<h2>Import vinlager (CSV)</h2>
<input type="file" id="csvFile" accept=".csv">
<br>

<button onclick="startImport('overwrite')">Overskriv lager</button>
<button onclick="startImport('add')">Tilf√∏j nye vine</button>
<button onclick="startImport('price')">Opdater kun priser</button>
<button onclick="resetInventory()">Nulstil lager</button>

<p id="importStatus"></p>

<hr>

<h2>Vinlager</h2>
<div class="total" id="totalValue">Samlet lagerv√¶rdi: 0,00 kr.</div>

<table>
<thead>
<tr>
  <th>Navn</th>
  <th>Type</th>
  <th>Land</th>
  <th>Region</th>
  <th>Reol</th>
  <th>Hylde</th>
  <th>Antal</th>
  <th>Indk√∏bspris</th>
</tr>
</thead>
<tbody id="inventory"></tbody>
</table>

<hr>

<h2>Labels / QR-koder</h2>
<div id="labels"></div>

<script>
let wines = [];

/* ---------- IMPORT ---------- */
function startImport(mode) {
  const fileInput = document.getElementById("csvFile");
  const file = fileInput.files[0];
  if (!file) return alert("V√¶lg en CSV-fil");

  const reader = new FileReader();
  reader.onload = e => parseCSV(e.target.result, mode);
  reader.readAsText(file, "UTF-8");
}

function parseCSV(text, mode) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(";").map(h => h.trim());

  let added = 0, updated = 0;

  if (mode === "overwrite") wines = [];

  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(";");
    const w = {};
    headers.forEach((h, idx) => w[h] = values[idx]?.trim());

    w.vinId = w.vinId || crypto.randomUUID();
    w.quantity = Number(w.quantity || 0);
    w.price = Number(w.price || 0);

    const existing = wines.find(x => x.vinId === w.vinId || x.name === w.name);

    if (!existing) {
      if (mode !== "price") {
        wines.push(w);
        added++;
      }
    } else {
      if (mode === "price") {
        existing.price = w.price;
        updated++;
      }
    }
  }

  document.getElementById("importStatus").innerText =
    `Import f√¶rdig ‚Äì Tilf√∏jet: ${added}, Opdateret: ${updated}`;

  document.getElementById("csvFile").value = "";
  render();
}

/* ---------- RESET ---------- */
function resetInventory() {
  if (!confirm("Er du sikker p√•, at du vil nulstille hele lageret?")) return;
  wines = [];
  render();
}

/* ---------- RENDER ---------- */
function render() {
  const tbody = document.getElementById("inventory");
  const labels = document.getElementById("labels");
  const totalEl = document.getElementById("totalValue");

  tbody.innerHTML = "";
  labels.innerHTML = "";

  let total = 0;

  wines.forEach(w => {
    total += w.quantity * w.price;

    tbody.innerHTML += `
      <tr>
        <td>${w.name}</td>
        <td>${w.category}</td>
        <td>${w.country}</td>
        <td>${w.region}</td>
        <td>${w.reol}</td>
        <td>${w.hylde}</td>
        <td class="right">${w.quantity}</td>
        <td class="right">${formatDKK(w.price)}</td>
      </tr>
    `;

    const div = document.createElement("div");
    div.className = "label";
    div.innerHTML = `
      <strong>${w.name}</strong><br>
      ${w.category}<br>
      ${w.country} ‚Äì ${w.region}<br>
      Reol ${w.reol} ¬∑ Hylde ${w.hylde}<br>
      <canvas id="qr-${w.vinId}"></canvas>
    `;
    labels.appendChild(div);

    QRCode.toCanvas(
      document.getElementById(`qr-${w.vinId}`),
      w.vinId,
      { width: 120 }
    );
  });

  totalEl.innerText = "Samlet lagerv√¶rdi: " + formatDKK(total);
}

/* ---------- FORMAT ---------- */
function formatDKK(n) {
  return n.toLocaleString("da-DK", {
    style: "currency",
    currency: "DKK"
  });
}
</script>

</body>
</html>
